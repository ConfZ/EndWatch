/*
Commit Number: v3.6.0-0-g3a34e44d02c9
URL: https://gitlab.com/wireshark/wireshark/-/issues/17813
Project Name: Wireshark
termination: FALSE
*/
#include "assert.h"
#include <stdlib.h>
#include <stdio.h>
#define NULL 0
struct tvbuff{
    unsigned char *real_data;
    unsigned int	length;
};
struct tvbuff;
typedef struct tvbuff tvbuff_t;
char tvb_get_guint8 (tvbuff_t* tv, int offset){
    if (offset>= tv->length) return NULL;
    return *(tv->real_data + offset);
}

static inline unsigned short pntoh16(const char *p)
{
    return (unsigned short)*((const unsigned char*)(p)+0)<<8|
           (unsigned short)*((const unsigned char*)(p)+1)<<0;
}
static inline unsigned int pntoh32(const char *p)
{
    return (unsigned int)*((const unsigned char *)(p)+0)<<24|
           (unsigned int)*((const unsigned char *)(p)+1)<<16|
           (unsigned int)*((const unsigned char *)(p)+2)<<8|
           (unsigned int)*((const unsigned char *)(p)+3)<<0;
}
unsigned short tvb_get_ntohs(tvbuff_t *tvb, const int offset)
{
    unsigned char* ptr;
    if (offset >= tvb->length)
        ptr = NULL;
    else
        ptr = tvb->real_data + offset;
    return pntoh16(ptr);
}


unsigned int tvb_get_ntohl(tvbuff_t *tvb, const int offset)
{
    unsigned char* ptr;
    if (offset >= tvb->length)
        ptr = NULL;
    else
    ptr = tvb->real_data + offset;
        return pntoh32(ptr);
}



int main(){
    unsigned int length = __VERIFIER_nondet_int();
    unsigned int offset = __VERIFIER_nondet_int();
    unsigned char* real_data;
    real_data = (unsigned char*)malloc(sizeof(unsigned char)*(length+1));
    if (!real_data) return 0;
    for (unsigned int i = 0; i < length; ++i) {
        *(real_data + i) = __VERIFIER_nondet_uchar();
    }

    tvbuff_t *tvb = (tvbuff_t*)malloc(sizeof (tvbuff_t));
    tvb->real_data = real_data;
    tvb->length = length;




    int remain = tvb->length - offset;
    if(remain <0) return 0;
    unsigned int depth   = 0;
    int  itemlen = 0;
    int  rv      = 0;

    while (rv == 0 || depth > 0) {
        char  iObjType;
        if (depth > 0) {
            if (remain-rv < 2)
                return remain;
            itemlen = tvb_get_ntohs(tvb, offset+rv) + 2;
            if (remain-rv<itemlen+1)
                return remain;
            rv += itemlen;
        }
        printf("itemlen is: %d\n", iObjType);
        if (remain-rv < 1)
            return remain;
        iObjType = tvb_get_guint8(tvb, offset+rv);
        printf("iObjType is: %d\n", iObjType);
        if (depth > 0 && itemlen == 2 && iObjType == 0x09) {
            rv++;
            depth--;
            continue;
        }

        switch (iObjType) {
            case 0x00:
                itemlen = 9;
                break;
            case 0x01:
                itemlen = 2;
                break;
            case 0x02:
                if (remain-rv < 3)
                    return remain;
                itemlen = tvb_get_ntohs(tvb, offset+rv+1) + 3;

                break;
            case 0x05:
            case 0x06:
            case 0x0D:
                itemlen= 1;
                break;
            case 0x0B:
                itemlen = 11;
                break;
            case 0x0C:
            case 0x0F:
                if (remain-rv < 5)
                    return remain;
                itemlen = tvb_get_ntohl(tvb, offset+rv+1) + 5;
                break;
            case 0x22:
                itemlen = 9;
                break;
            case 0x03:
                itemlen = 1;
                depth++;
                break;
            case 0x08:
                itemlen = 5;
                depth++;
                break;
            default:
                return remain;
        }

        if (remain-rv < itemlen)
            return remain;

        rv += itemlen;
        printf("itemlen is: %d\n", itemlen);
    }

    return rv;
}
